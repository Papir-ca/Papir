<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Papir Admin - Card Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #1a1a1a; color: white; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        h1 { color: #BCAE83; margin-bottom: 30px; font-size: 2.5rem; }
        
        /* Search Bar */
        .search-bar { background: #2a2a2a; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .search-input { width: 100%; padding: 12px 20px; background: #333; border: 2px solid #444; border-radius: 8px; color: white; font-size: 16px; }
        .search-input:focus { outline: none; border-color: #BCAE83; }
        
        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: #2a2a2a; padding: 20px; border-radius: 10px; text-align: center; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); background: #333; }
        .stat-value { font-size: 2rem; color: #BCAE83; font-weight: bold; }
        .stat-label { color: #aaa; margin-top: 5px; }
        
        /* Cards Table */
        .cards-table-container { background: #2a2a2a; border-radius: 10px; overflow: hidden; margin-bottom: 40px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #364B4A; padding: 15px; text-align: left; font-weight: 600; color: #BCAE83; }
        td { padding: 12px 15px; border-bottom: 1px solid #444; }
        tr:hover { background: #333; }
        
        /* Action Buttons */
        .action-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        .action-btn { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
        .view-btn { background: #BCAE83; color: black; }
        .qr-btn { background: #364B4A; color: white; }
        .copy-btn { background: #555; color: white; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* Media URL */
        .media-url { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #06D6A0; }
        .media-url a { color: #06D6A0; text-decoration: none; }
        .media-url a:hover { text-decoration: underline; }
        
        /* QR Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: #2a2a2a; padding: 30px; border-radius: 15px; max-width: 500px; margin: 100px auto; text-align: center; }
        .modal-qr { width: 250px; height: 250px; margin: 20px auto; border: 10px solid white; border-radius: 10px; }
        .close-modal { background: #ff416c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        
        /* Controls */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; background: #444; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .filter-btn.active { background: #BCAE83; color: black; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: #aaa; }
        .spinner { border: 4px solid #333; border-top: 4px solid #BCAE83; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Type badges */
        .type-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .type-text { background: #3498db; }
        .type-image { background: #2ecc71; }
        .type-video { background: #e74c3c; }
        .type-audio { background: #9b59b6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“Š Papir Admin Dashboard</h1>
        
        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search by Card ID, file name, or type...">
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <button class="filter-btn active" data-filter="all">All Cards</button>
            <button class="filter-btn" data-filter="video">Video Cards</button>
            <button class="filter-btn" data-filter="image">Image Cards</button>
            <button class="filter-btn" data-filter="audio">Audio Cards</button>
            <button class="filter-btn" data-filter="text">Text Cards</button>
            <button class="filter-btn" id="refreshBtn">ðŸ”„ Refresh</button>
        </div>
        
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCards">0</div>
                <div class="stat-label">Total Cards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="videoCards">0</div>
                <div class="stat-label">Video Cards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="imageCards">0</div>
                <div class="stat-label">Image Cards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="audioCards">0</div>
                <div class="stat-label">Audio Cards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="textCards">0</div>
                <div class="stat-label">Text Cards</div>
            </div>
        </div>
        
        <!-- Cards Table -->
        <div class="cards-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Card ID</th>
                        <th>Type</th>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Media URL</th>
                        <th>Created</th>
                        <th>IP Address</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cardsTableBody">
                    <tr>
                        <td colspan="8" class="loading">
                            <div class="spinner"></div>
                            <div>Loading cards...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- QR Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <h2 id="modalCardId">CARD123</h2>
            <div id="modalCardType">Type: Video</div>
            <img id="modalQrImage" class="modal-qr" src="" alt="QR Code">
            <div style="margin: 20px 0;">
                <input type="text" id="qrUrlInput" style="width: 100%; padding: 10px; background: #333; color: white; border: none; border-radius: 5px; margin-bottom: 10px;">
                <div class="action-btns" style="justify-content: center;">
                    <button class="action-btn copy-btn" onclick="copyQrUrl()">Copy URL</button>
                    <button class="action-btn qr-btn" onclick="downloadQr()">Download QR</button>
                </div>
            </div>
            <button class="close-modal" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://papir.ca';
        let allCards = [];
        let currentFilter = 'all';
        let currentQRData = null;
        
        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const filterBtns = document.querySelectorAll('.filter-btn');
        const qrModal = document.getElementById('qrModal');
        
        // Load admin data
        async function loadAdminData() {
            showLoading(true);
            try {
                const response = await fetch(`${BACKEND_URL}/api/cards`);
                const result = await response.json();
                
                if (result.success && result.cards) {
                    allCards = result.cards;
                    updateStats(allCards);
                    filterAndDisplayCards();
                }
            } catch (error) {
                console.error('Admin load error:', error);
                alert('Error loading cards: ' + error.message);
            }
            showLoading(false);
        }
        
        // Update statistics
        function updateStats(cards) {
            document.getElementById('totalCards').textContent = cards.length;
            document.getElementById('videoCards').textContent = cards.filter(c => c.message_type === 'video').length;
            document.getElementById('imageCards').textContent = cards.filter(c => c.message_type === 'image').length;
            document.getElementById('audioCards').textContent = cards.filter(c => c.message_type === 'audio').length;
            document.getElementById('textCards').textContent = cards.filter(c => c.message_type === 'text').length;
        }
        
        // Filter and display cards
        function filterAndDisplayCards() {
            let filteredCards = allCards;
            
            // Apply type filter
            if (currentFilter !== 'all') {
                filteredCards = filteredCards.filter(card => card.message_type === currentFilter);
            }
            
            // Apply search filter
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredCards = filteredCards.filter(card => 
                    card.card_id.toLowerCase().includes(searchTerm) ||
                    (card.file_name && card.file_name.toLowerCase().includes(searchTerm)) ||
                    card.message_type.toLowerCase().includes(searchTerm)
                );
            }
            
            displayCards(filteredCards);
        }
        
        // Display cards in table
        function displayCards(cards) {
            const tbody = document.getElementById('cardsTableBody');
            
            if (cards.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #aaa;">
                            No cards found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            cards.forEach(card => {
                const typeClass = `type-${card.message_type}`;
                const typeDisplay = card.message_type.charAt(0).toUpperCase() + card.message_type.slice(1);
                const sizeDisplay = card.file_size ? formatFileSize(card.file_size) : 'N/A';
                const viewerUrl = `${BACKEND_URL}/viewer.html?card=${card.card_id}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(viewerUrl)}`;
                
                html += `
                    <tr>
                        <td><strong>${card.card_id}</strong></td>
                        <td><span class="type-badge ${typeClass}">${typeDisplay}</span></td>
                        <td>${card.file_name || 'N/A'}</td>
                        <td>${sizeDisplay}</td>
                        <td class="media-url">
                            ${card.media_url ? `<a href="${card.media_url}" target="_blank">View Media</a>` : 'N/A'}
                        </td>
                        <td>${new Date(card.created_at).toLocaleDateString()}</td>
                        <td>${card.created_by_ip || 'N/A'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn view-btn" onclick="viewCard('${card.card_id}')">View</button>
                                <button class="action-btn qr-btn" onclick="showQR('${card.card_id}', '${typeDisplay}', '${viewerUrl}', '${qrUrl}')">QR</button>
                                ${card.media_url ? `<button class="action-btn copy-btn" onclick="copyToClipboard('${card.media_url}')">Copy URL</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // View card
        function viewCard(cardId) {
            window.open(`${BACKEND_URL}/viewer.html?card=${cardId}`, '_blank');
        }
        
        // Show QR modal
        function showQR(cardId, type, viewerUrl, qrUrl) {
            document.getElementById('modalCardId').textContent = cardId;
            document.getElementById('modalCardType').textContent = `Type: ${type}`;
            document.getElementById('modalQrImage').src = qrUrl;
            document.getElementById('qrUrlInput').value = viewerUrl;
            
            currentQRData = { cardId, viewerUrl, qrUrl };
            qrModal.style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            qrModal.style.display = 'none';
        }
        
        // Copy QR URL
        function copyQrUrl() {
            const urlInput = document.getElementById('qrUrlInput');
            urlInput.select();
            navigator.clipboard.writeText(urlInput.value)
                .then(() => alert('URL copied to clipboard!'))
                .catch(err => console.error('Copy failed:', err));
        }
        
        // Download QR code
        function downloadQr() {
            if (!currentQRData) return;
            
            const link = document.createElement('a');
            link.href = currentQRData.qrUrl;
            link.download = `papir_${currentQRData.cardId}_qr.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Copy media URL
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => alert('URL copied to clipboard!'))
                .catch(err => console.error('Copy failed:', err));
        }
        
        // Show loading state
        function showLoading(show) {
            const tbody = document.getElementById('cardsTableBody');
            if (show) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="loading">
                            <div class="spinner"></div>
                            <div>Loading cards...</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Event Listeners
        searchInput.addEventListener('input', filterAndDisplayCards);
        refreshBtn.addEventListener('click', loadAdminData);
        
        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                filterBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                filterAndDisplayCards();
            });
        });
        
        // Close modal on outside click
        window.addEventListener('click', function(event) {
            if (event.target === qrModal) {
                closeModal();
            }
        });
        
        // Initial load
        loadAdminData();
        // Auto-refresh every 30 seconds
        setInterval(loadAdminData, 30000);
    </script>
</body>
</html>
