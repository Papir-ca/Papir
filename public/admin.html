<script>
    const BACKEND_URL = 'https://papir.ca';
    let allCards = [];
    let currentFilter = 'all';
    let currentQRData = null;
    let isLoading = false;
    
    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const refreshBtn = document.getElementById('refreshBtn');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const qrModal = document.getElementById('qrModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const copyQrUrlBtn = document.getElementById('copyQrUrlBtn');
    const downloadQrBtn = document.getElementById('downloadQrBtn');
    
    // Load admin data
    async function loadAdminData() {
        if (isLoading) return;
        
        isLoading = true;
        showLoading(true);
        updateRefreshButton('Refreshing...');
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/cards`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success && result.cards) {
                allCards = result.cards;
                updateStats(allCards);
                filterAndDisplayCards();
                showToast('Cards refreshed successfully!', 'success');
            } else {
                throw new Error(result.message || 'Failed to load cards');
            }
        } catch (error) {
            console.error('Admin load error:', error);
            showToast(`Error: ${error.message}`, 'error');
            
            // For testing: fallback to dummy data
            if (allCards.length === 0) {
                console.log('Using fallback data for testing');
                allCards = getFallbackData();
                updateStats(allCards);
                filterAndDisplayCards();
            }
        } finally {
            isLoading = false;
            showLoading(false);
            updateRefreshButton('ðŸ”„ Refresh');
        }
    }
    
    // Update refresh button state
    function updateRefreshButton(text) {
        refreshBtn.textContent = text;
        refreshBtn.disabled = isLoading;
    }
    
    // Show toast notification
    function showToast(message, type = 'info') {
        // Remove existing toast
        const existingToast = document.querySelector('.toast');
        if (existingToast) existingToast.remove();
        
        // Create toast
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        // Style the toast
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'error' ? '#e74c3c' : '#2ecc71'};
            color: white;
            border-radius: 5px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-weight: bold;
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 3000);
        
        // Add CSS animations
        if (!document.querySelector('#toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    // Fallback data for testing
    function getFallbackData() {
        const types = ['video', 'image', 'audio', 'text'];
        const fallbackCards = [];
        
        for (let i = 1; i <= 20; i++) {
            const type = types[Math.floor(Math.random() * types.length)];
            fallbackCards.push({
                card_id: `CARD${1000 + i}`,
                message_type: type,
                file_name: `${type}_file_${i}.${getExtension(type)}`,
                file_size: Math.floor(Math.random() * 1000000) + 100000,
                media_url: type === 'text' ? null : `https://example.com/media/${type}_${i}`,
                created_at: new Date(Date.now() - Math.random() * 10000000000).toISOString(),
                created_by_ip: `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`
            });
        }
        
        return fallbackCards;
    }
    
    function getExtension(type) {
        switch(type) {
            case 'video': return 'mp4';
            case 'image': return 'jpg';
            case 'audio': return 'mp3';
            default: return 'txt';
        }
    }
    
    // Update statistics
    function updateStats(cards) {
        document.getElementById('totalCards').textContent = cards.length;
        document.getElementById('videoCards').textContent = cards.filter(c => c.message_type === 'video').length;
        document.getElementById('imageCards').textContent = cards.filter(c => c.message_type === 'image').length;
        document.getElementById('audioCards').textContent = cards.filter(c => c.message_type === 'audio').length;
        document.getElementById('textCards').textContent = cards.filter(c => c.message_type === 'text').length;
    }
    
    // Filter and display cards
    function filterAndDisplayCards() {
        let filteredCards = allCards;
        
        // Apply type filter
        if (currentFilter !== 'all') {
            filteredCards = filteredCards.filter(card => card.message_type === currentFilter);
        }
        
        // Apply search filter
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            filteredCards = filteredCards.filter(card => 
                card.card_id.toLowerCase().includes(searchTerm) ||
                (card.file_name && card.file_name.toLowerCase().includes(searchTerm)) ||
                card.message_type.toLowerCase().includes(searchTerm)
            );
        }
        
        displayCards(filteredCards);
    }
    
    // Display cards in table
    function displayCards(cards) {
        const tbody = document.getElementById('cardsTableBody');
        
        if (cards.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #aaa;">
                        No cards found matching your criteria.
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        cards.forEach(card => {
            const typeClass = `type-${card.message_type}`;
            const typeDisplay = card.message_type.charAt(0).toUpperCase() + card.message_type.slice(1);
            const sizeDisplay = card.file_size ? formatFileSize(card.file_size) : 'N/A';
            const viewerUrl = `${BACKEND_URL}/viewer.html?card=${card.card_id}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(viewerUrl)}&format=png&margin=10`;
            
            // Generate a unique ID for each action button
            const viewBtnId = `view-btn-${card.card_id}`;
            const qrBtnId = `qr-btn-${card.card_id}`;
            const copyBtnId = `copy-btn-${card.card_id}`;
            
            html += `
                <tr>
                    <td><strong>${card.card_id}</strong></td>
                    <td><span class="type-badge ${typeClass}">${typeDisplay}</span></td>
                    <td>${card.file_name || 'N/A'}</td>
                    <td>${sizeDisplay}</td>
                    <td class="media-url">
                        ${card.media_url ? 
                            `<div>
                                <a href="${card.media_url}" target="_blank">View Media</a><br>
                                <small style="color: #aaa; font-size: 0.8rem; word-break: break-all;">${card.media_url}</small>
                            </div>` 
                            : 'N/A'}
                    </td>
                    <td>${new Date(card.created_at).toLocaleDateString()}</td>
                    <td>${card.created_by_ip || 'N/A'}</td>
                    <td>
                        <div class="action-btns">
                            <button class="action-btn view-btn" id="${viewBtnId}" data-card-id="${card.card_id}">View</button>
                            <button class="action-btn qr-btn" id="${qrBtnId}" data-card-id="${card.card_id}" data-card-type="${typeDisplay}" data-viewer-url="${viewerUrl}" data-qr-url="${qrUrl}">QR</button>
                            ${card.media_url ? `<button class="action-btn copy-btn" id="${copyBtnId}" data-media-url="${card.media_url}">Copy URL</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        
        // Add event listeners to all action buttons
        cards.forEach(card => {
            const viewBtnId = `view-btn-${card.card_id}`;
            const qrBtnId = `qr-btn-${card.card_id}`;
            const copyBtnId = `copy-btn-${card.card_id}`;
            
            // View button
            const viewBtn = document.getElementById(viewBtnId);
            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    window.open(`${BACKEND_URL}/viewer.html?card=${card.card_id}`, '_blank');
                });
            }
            
            // QR button
            const qrBtn = document.getElementById(qrBtnId);
            if (qrBtn) {
                qrBtn.addEventListener('click', function() {
                    const cardId = this.getAttribute('data-card-id');
                    const cardType = this.getAttribute('data-card-type');
                    const viewerUrl = this.getAttribute('data-viewer-url');
                    const qrUrl = this.getAttribute('data-qr-url');
                    showQR(cardId, cardType, viewerUrl, qrUrl);
                });
            }
            
            // Copy URL button
            const copyBtn = document.getElementById(copyBtnId);
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const mediaUrl = this.getAttribute('data-media-url');
                    copyToClipboard(mediaUrl);
                });
            }
        });
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Show QR modal
    function showQR(cardId, type, viewerUrl, qrUrl) {
        document.getElementById('modalCardId').textContent = cardId;
        document.getElementById('modalCardType').textContent = `Type: ${type}`;
        document.getElementById('modalQrImage').src = qrUrl;
        document.getElementById('qrUrlInput').value = viewerUrl;
        
        currentQRData = { cardId, viewerUrl, qrUrl };
        qrModal.style.display = 'block';
    }
    
    // Close modal
    function closeModal() {
        qrModal.style.display = 'none';
    }
    
    // Copy QR URL
    function copyQrUrl() {
        const urlInput = document.getElementById('qrUrlInput');
        urlInput.select();
        navigator.clipboard.writeText(urlInput.value)
            .then(() => showToast('URL copied to clipboard!', 'success'))
            .catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy URL', 'error');
            });
    }
    
    // Download QR code
    function downloadQr() {
        if (!currentQRData) return;
        
        const link = document.createElement('a');
        link.href = currentQRData.qrUrl;
        link.download = `papir_${currentQRData.cardId}_qr.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('QR code downloaded!', 'success');
    }
    
    // Copy media URL
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text)
            .then(() => showToast('URL copied to clipboard!', 'success'))
            .catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy URL', 'error');
            });
    }
    
    // Show loading state
    function showLoading(show) {
        const tbody = document.getElementById('cardsTableBody');
        if (show && tbody.children.length === 1 && tbody.children[0].querySelector('.spinner')) {
            // Already showing loading spinner
            return;
        }
        
        if (show) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <div class="spinner"></div>
                        <div>Loading cards...</div>
                    </td>
                </tr>
            `;
        }
    }
    
    // Initialize event listeners
    function initializeEventListeners() {
        // Search input
        searchInput.addEventListener('input', filterAndDisplayCards);
        
        // Refresh button
        refreshBtn.addEventListener('click', loadAdminData);
        
        // Filter buttons
        filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.id === 'refreshBtn') return;
                
                filterBtns.forEach(b => {
                    if (b.id !== 'refreshBtn') b.classList.remove('active');
                });
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                filterAndDisplayCards();
            });
        });
        
        // Modal buttons
        closeModalBtn.addEventListener('click', closeModal);
        copyQrUrlBtn.addEventListener('click', copyQrUrl);
        downloadQrBtn.addEventListener('click', downloadQr);
        
        // Close modal on outside click
        window.addEventListener('click', function(event) {
            if (event.target === qrModal) {
                closeModal();
            }
        });
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && qrModal.style.display === 'block') {
                closeModal();
            }
        });
    }
    
    // Initial load
    initializeEventListeners();
    loadAdminData();
    
    // Auto-refresh every 30 seconds (optional)
    // setInterval(loadAdminData, 30000);
</script>
