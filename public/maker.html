<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Card Generator | Papir</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        header {
            text-align: center;
            color: white;
            padding: 20px;
            position: relative;
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.5;
        }
        
        .card-creator {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            flex: 1;
            min-width: 300px;
            max-width: 550px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            flex: 1;
            min-width: 300px;
            max-width: 550px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #6a11cb;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        .card-id-container {
            display: flex;
            gap: 10px;
        }
        
        .card-id-prefix {
            background: #f0f0f0;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: bold;
            color: #555;
            border: 1px solid #ddd;
        }
        
        #cardId {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        #cardId:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        /* Dropdown Styles - REPLACED Radio Buttons */
        .content-type-dropdown {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .content-type-dropdown:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        .content-type-dropdown option {
            padding: 10px;
        }
        
        .message-input textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s;
        }
        
        .message-input textarea:focus {
            border-color: #6a11cb;
            outline: none;
        }
        
        /* Media Upload Styles */
        .media-upload-container {
            display: none;
            margin-top: 15px;
        }
        
        .media-upload-container.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed #6a11cb;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #f9f5ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: #f0e6ff;
            border-color: #2575fc;
        }
        
        .upload-area i {
            font-size: 3rem;
            color: #6a11cb;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .upload-subtext {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-preview {
            margin-top: 20px;
            display: none;
        }
        
        .file-preview.active {
            display: block;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .preview-audio {
            width: 100%;
            margin-top: 10px;
        }
        
        .preview-video {
            width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .preview-filename {
            font-size: 0.9rem;
            color: #555;
            margin-top: 10px;
            word-break: break-all;
        }
        
        .remove-media-btn {
            background-color: #ff416c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .remove-media-btn:hover {
            background-color: #ff2b5e;
        }
        
        .upload-progress {
            margin-top: 15px;
            display: none;
        }
        
        .upload-progress.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
        }
        
        .button-container {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-3px);
        }
        
        .btn-success {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .preview-card {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            background-color: #f9f9f9;
            min-height: 300px;
        }
        
        .card-content {
            max-width: 100%;
        }
        
        .text-content {
            font-size: 2rem;
            color: #333;
            font-weight: 600;
            margin: 20px 0;
        }
        
        .card-id-display {
            font-size: 1.2rem;
            color: #666;
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        .content-type-display {
            display: inline-block;
            background: #e0e6ff;
            color: #2d4cc7;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .empty-preview {
            color: #999;
            font-size: 1.1rem;
        }
        
        .preview-instructions {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
        }
        
        .card-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .cards-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .cards-table th {
            background-color: #f5f5f5;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #eee;
            color: #555;
        }
        
        .cards-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .empty-row {
            text-align: center;
            color: #999;
            padding: 30px !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 5px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #e0e0e0;
        }
        
        .action-btn.view {
            background: #e0e6ff;
            color: #2d4cc7;
        }
        
        .action-btn.delete {
            background: #ffe0e0;
            color: #c72d2d;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.5s;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(to right, #00b09b, #96c93d);
        }
        
        .notification.error {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }
        
        .notification.info {
            background: linear-gradient(to right, #36D1DC, #5B86E5);
        }
        
        .scanner-nav-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            text-decoration: none;
            color: #6a11cb;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .scanner-nav-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            background: #f8f5ff;
        }
        
        .sync-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(5px);
        }
        
        .sync-status.online {
            background: rgba(0, 176, 155, 0.3);
        }
        
        .sync-status.offline {
            background: rgba(255, 65, 108, 0.3);
        }
        
        /* QR Code Styles */
        .qr-code-img {
            width: 250px;
            height: 250px;
            border: 10px solid white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 0 auto 20px;
            display: block;
        }
        
        .qr-success {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .qr-success i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
        
        .share-url-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .share-url-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            background: #f9f9f9;
        }
        
        .copy-btn {
            padding: 10px 20px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
        }
        
        .phone-test-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s;
        }
        
        .phone-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        @media (max-width: 768px) {
            .card-creator {
                flex-direction: column;
            }
            
            .form-section, .preview-section {
                max-width: 100%;
            }
            
            .button-container {
                flex-direction: column;
            }
            
            .btn {
                min-width: 100%;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .scanner-nav-button, .sync-status {
                position: relative;
                top: 0;
                left: 0;
                right: 0;
                margin: 10px auto;
                display: inline-flex;
                justify-content: center;
            }
            
            header {
                padding-top: 60px;
            }
            
            .qr-code-img {
                width: 200px;
                height: 200px;
            }
            
            .share-url-container {
                flex-direction: column;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6a11cb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation & Status -->
        <div class="sync-status" id="syncStatus">
            <i class="fas fa-check-circle"></i>
            <span>Connected to Papir Backend</span>
        </div>
        
        <a href="viewer.html" class="scanner-nav-button">
            <i class="fas fa-camera"></i> Scan Cards
        </a>
        
        <header>
            <h1><i class="fas fa-magic"></i> Papir AR Card Creator</h1>
            <p>Design magical AR cards with text, images, video or audio. Your cards are saved securely through our backend API.</p>
        </header>
        
        <div class="card-creator">
            <!-- Form Section -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-edit"></i> Card Details
                </div>
                
                <div class="form-group">
                    <label for="cardId">Card ID (Required):</label>
                    <div class="card-id-container">
                        <div class="card-id-prefix">CARD</div>
                        <input type="text" id="cardId" placeholder="6842" value="6842">
                    </div>
                    <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Format: CARD followed by numbers. Must be unique for each card.
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contentType">Content Type:</label>
                    <select id="contentType" class="content-type-dropdown">
                        <option value="text" selected>Text Message</option>
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                        <option value="audio">Audio</option>
                    </select>
                </div>
                
                <!-- Text Message Input -->
                <div class="form-group" id="textMessageContainer">
                    <label for="message">Your Message:</label>
                    <div class="message-input">
                        <textarea id="message" placeholder="Enter your message here...">Happy Birthday ðŸ˜Š</textarea>
                    </div>
                </div>
                
                <!-- Media Upload Containers -->
                <div class="form-group">
                    <!-- Image Upload -->
                    <div class="media-upload-container" id="imageUploadContainer">
                        <div class="upload-area" id="imageUploadArea">
                            <i class="fas fa-image"></i>
                            <div class="upload-text">Click to upload image</div>
                            <div class="upload-subtext">JPG, PNG, GIF up to 5MB</div>
                            <input type="file" id="imageInput" class="file-input" accept="image/*">
                        </div>
                        <div class="file-preview" id="imagePreview">
                            <img src="" alt="Preview" class="preview-image" id="previewImage">
                            <div class="preview-filename" id="imageFilename"></div>
                            <button class="remove-media-btn" onclick="removeImage()">
                                <i class="fas fa-trash"></i> Remove Image
                            </button>
                        </div>
                        <div class="upload-progress" id="imageProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="imageProgressFill"></div>
                            </div>
                            <div class="progress-text" id="imageProgressText">Uploading...</div>
                        </div>
                    </div>
                    
                    <!-- Video Upload -->
                    <div class="media-upload-container" id="videoUploadContainer">
                        <div class="upload-area" id="videoUploadArea">
                            <i class="fas fa-video"></i>
                            <div class="upload-text">Click to upload video</div>
                            <div class="upload-subtext">MP4, WebM up to 40MB</div>
                            <input type="file" id="videoInput" class="file-input" accept="video/*">
                        </div>
                        <div class="file-preview" id="videoPreview">
                            <video controls class="preview-video" id="previewVideo"></video>
                            <div class="preview-filename" id="videoFilename"></div>
                            <button class="remove-media-btn" onclick="removeVideo()">
                                <i class="fas fa-trash"></i> Remove Video
                            </button>
                        </div>
                        <div class="upload-progress" id="videoProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="videoProgressFill"></div>
                            </div>
                            <div class="progress-text" id="videoProgressText">Uploading...</div>
                        </div>
                    </div>
                    
                    <!-- Audio Upload -->
                    <div class="media-upload-container" id="audioUploadContainer">
                        <div class="upload-area" id="audioUploadArea">
                            <i class="fas fa-music"></i>
                            <div class="upload-text">Click to upload audio</div>
                            <div class="upload-subtext">MP3, WAV up to 10MB</div>
                            <input type="file" id="audioInput" class="file-input" accept="audio/*">
                        </div>
                        <div class="file-preview" id="audioPreview">
                            <audio controls class="preview-audio" id="previewAudio"></audio>
                            <div class="preview-filename" id="audioFilename"></div>
                            <button class="remove-media-btn" onclick="removeAudio()">
                                <i class="fas fa-trash"></i> Remove Audio
                            </button>
                        </div>
                        <div class="upload-progress" id="audioProgress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="audioProgressFill"></div>
                            </div>
                            <div class="progress-text" id="audioProgressText">Uploading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="button-container">
                    <button class="btn btn-primary" id="generateBtn">
                        <i class="fas fa-bolt"></i> Generate Card
                    </button>
                    <button class="btn btn-success" id="saveBtn">
                        <i class="fas fa-save"></i> Save to Database
                    </button>
                    <button class="btn btn-secondary" id="testBtn">
                        <i class="fas fa-play"></i> Test Card
                    </button>
                </div>
            </div>
            
            <!-- Preview Section -->
            <div class="preview-section">
                <div class="section-title">
                    <i class="fas fa-eye"></i> Preview
                </div>
                
                <div class="preview-card">
                    <div class="card-content" id="cardPreview">
                        <div class="card-id-display">CARD6842</div>
                        <div class="text-content">Happy Birthday ðŸ˜Š</div>
                        <div class="content-type-display">Text Message</div>
                    </div>
                </div>
                
                <div class="preview-instructions">
                    <i class="fas fa-info-circle"></i> This is how your AR card will appear. The card ID and content type will be visible when the card is scanned in AR mode.
                </div>
            </div>
        </div>
        
        <!-- QR Code Display Section -->
        <div class="card-list" id="qrCodeSection" style="display: none;">
            <div class="section-title">
                <i class="fas fa-qrcode"></i> Your Card's QR Code
            </div>
            <p>Scan this QR code with any phone camera to view your card!</p>
            
            <div style="text-align: center; padding: 30px;">
                <div id="qrCodeContainer" style="margin: 0 auto; max-width: 300px;">
                    <!-- QR code will appear here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="color: #2d4cc7; margin-bottom: 10px;">Share Your Card:</h4>
                        <div class="share-url-container">
                            <input type="text" id="shareableUrl" class="share-url-input" readonly>
                            <button class="copy-btn" onclick="copyShareUrl()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <p style="font-size: 0.9rem; color: #666;">
                            <i class="fas fa-mobile-alt"></i> Works on any smartphone - no app needed!
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="phone-test-btn" onclick="testOnPhone()">
                            <i class="fas fa-mobile-alt"></i> Test on Phone
                        </button>
                        <button class="btn btn-secondary" onclick="hideQRCode()" style="min-width: 150px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <button class="btn btn-success" onclick="printQRCode()" style="min-width: 150px;">
                            <i class="fas fa-print"></i> Print QR Code
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Card List Section -->
        <div class="card-list">
            <div class="section-title">
                <i class="fas fa-list"></i> Saved Cards (Database)
            </div>
            <p>Cards saved to your secure backend database. Click "View" to load, "Delete" to remove.</p>
            
            <table class="cards-table">
                <thead>
                    <tr>
                        <th>Card ID</th>
                        <th>Content Type</th>
                        <th>Message</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="cardsTableBody">
                    <tr class="empty-row">
                        <td colspan="5">
                            <div class="loading" style="margin-right: 10px;"></div>
                            Loading cards from database...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Notification Element -->
    <div class="notification" id="notification"></div>
    
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // Backend API configuration - YOUR SERVER!
                   const BACKEND_URL = 'https://papir.ca';
    let currentMedia = { image: null, video: null, audio: null };
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('Papir Maker loading...');
        
        // Test backend connection
        try {
            const response = await fetch(`${BACKEND_URL}/api/health`);
            if (response.ok) {
                document.getElementById('syncStatus').className = 'sync-status online';
                document.getElementById('syncStatus').innerHTML = 
                    '<i class="fas fa-check-circle"></i><span>Connected to Papir Backend</span>';
            }
        } catch (error) {
            console.log('Backend not available:', error);
        }
        
        // Setup event listeners
        setupMediaUploads();
        setupFormListeners();
        loadCards();
        
        // Initial preview
        updatePreview();
    });
    
    // Setup media upload functionality
    function setupMediaUploads() {
        // Image upload
        const imageInput = document.getElementById('imageInput');
        imageInput.addEventListener('change', (e) => handleFileUpload(e, 'image'));
        
        // Video upload
        const videoInput = document.getElementById('videoInput');
        videoInput.addEventListener('change', (e) => handleFileUpload(e, 'video'));
        
        // Audio upload
        const audioInput = document.getElementById('audioInput');
        audioInput.addEventListener('change', (e) => handleFileUpload(e, 'audio'));
        
        // Show/hide upload areas based on content type
        document.getElementById('contentType').addEventListener('change', () => {
            const type = document.getElementById('contentType').value;
            
            // Hide all
            document.getElementById('imageUploadContainer').classList.remove('active');
            document.getElementById('videoUploadContainer').classList.remove('active');
            document.getElementById('audioUploadContainer').classList.remove('active');
            document.getElementById('textMessageContainer').style.display = 'none';
            
            // Show relevant one
            if (type === 'image') {
                document.getElementById('imageUploadContainer').classList.add('active');
            } else if (type === 'video') {
                document.getElementById('videoUploadContainer').classList.add('active');
            } else if (type === 'audio') {
                document.getElementById('audioUploadContainer').classList.add('active');
            } else if (type === 'text') {
                document.getElementById('textMessageContainer').style.display = 'block';
            }
            
            updatePreview();
        });
    }
    
    // Handle file upload and preview
    function handleFileUpload(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        
        // Validate file size
        const maxSizes = { image: 5, video: 40, audio: 10 }; // MB
        if (file.size > maxSizes[type] * 1024 * 1024) {
            showNotification(`File too large (max ${maxSizes[type]}MB)`, 'error');
            event.target.value = '';
            return;
        }
        
        // Create preview
        if (type === 'image') {
            const reader = new FileReader();
            reader.onload = (e) => {
                currentMedia.image = {
                    file: file,
                    url: e.target.result,
                    name: file.name,
                    type: file.type
                };
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('imagePreview').classList.add('active');
                showNotification('Image uploaded', 'success');
                updatePreview();
            };
            reader.readAsDataURL(file);
        } else if (type === 'video') {
            currentMedia.video = {
                file: file,
                url: URL.createObjectURL(file),
                name: file.name,
                type: file.type
            };
            document.getElementById('previewVideo').src = currentMedia.video.url;
            document.getElementById('videoPreview').classList.add('active');
            showNotification('Video uploaded', 'success');
            updatePreview();
        } else if (type === 'audio') {
            currentMedia.audio = {
                file: file,
                url: URL.createObjectURL(file),
                name: file.name,
                type: file.type
            };
            document.getElementById('previewAudio').src = currentMedia.audio.url;
            document.getElementById('audioPreview').classList.add('active');
            showNotification('Audio uploaded', 'success');
            updatePreview();
        }
    }
    
    // Setup form event listeners
    function setupFormListeners() {
        // Generate button
        document.getElementById('generateBtn').addEventListener('click', () => {
            updatePreview();
            showNotification('Preview updated', 'success');
        });
        
        // Save button
        document.getElementById('saveBtn').addEventListener('click', saveCard);
        
        // Test button
        document.getElementById('testBtn').addEventListener('click', () => {
            const cardData = getCardData();
            if (cardData) {
                window.open(`viewer.html?card=${cardData.card_id}`, '_blank');
            }
        });
        
        // Real-time preview updates
        document.getElementById('cardId').addEventListener('input', updatePreview);
        document.getElementById('message').addEventListener('input', updatePreview);
    }
    
    // Update card preview
    function updatePreview() {
        const cardData = getCardData();
        if (!cardData) return;
        
        const preview = document.getElementById('cardPreview');
        const typeDisplay = cardData.message_type === 'text' ? 'Text Message' : 
                          cardData.message_type.charAt(0).toUpperCase() + cardData.message_type.slice(1);
        
        let content = '';
        if (cardData.message_type === 'text') {
            content = `<div class="text-content">${cardData.message_text || 'Your message here'}</div>`;
        } else {
            const media = currentMedia[cardData.message_type];
            if (media) {
                content = `
                    <div style="margin: 20px 0;">
                        <i class="fas fa-${cardData.message_type === 'image' ? 'image' : 
                                        cardData.message_type === 'video' ? 'video' : 'music'}" 
                           style="font-size: 3rem; color: #6a11cb;"></i>
                        <div style="color: #666; margin-top: 10px;">${media.name}</div>
                    </div>
                `;
            } else {
                content = `<div class="text-content" style="color: #999;">No ${cardData.message_type} uploaded</div>`;
            }
        }
        
        preview.innerHTML = `
            <div class="card-id-display">${cardData.card_id}</div>
            ${content}
            <div class="content-type-display">${typeDisplay}</div>
        `;
    }
    
    // Get card data from form
    function getCardData() {
        const cardId = document.getElementById('cardId').value.trim();
        if (!cardId || !/^\d+$/.test(cardId)) {
            showNotification('Card ID must be numbers only', 'error');
            return null;
        }
        
        const contentType = document.getElementById('contentType').value;
        const message = document.getElementById('message').value;
        
        return {
            card_id: `CARD${cardId}`,
            message_type: contentType,
            message_text: contentType === 'text' ? message : ''
        };
    }
    
    // Save card to backend
    async function saveCard() {
        const cardData = getCardData();
        if (!cardData) return;
        
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="loading"></span> Saving...';
        saveBtn.disabled = true;
        
        try {
            // Upload media first if needed
            const contentType = cardData.message_type;
            let mediaUrl = null;
            let fileData = {};
            
            if (contentType !== 'text' && currentMedia[contentType]) {
                showNotification(`Uploading ${contentType}...`, 'info');
                
                const formData = new FormData();
                formData.append('file', currentMedia[contentType].file);
                formData.append('cardId', cardData.card_id);
                formData.append('fileName', currentMedia[contentType].name);
                formData.append('fileType', currentMedia[contentType].type);
                
                const uploadResponse = await fetch(`${BACKEND_URL}/api/upload-media`, {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (uploadResult.success) {
                    mediaUrl = uploadResult.url;
                    fileData = {
                        file_name: uploadResult.fileName,
                        file_size: uploadResult.fileSize,
                        file_type: uploadResult.fileType,
                        file_url: uploadResult.url,
                        media_url: uploadResult.url
                    };
                    showNotification(`${contentType} uploaded!`, 'success');
                }
            }
            
            // Save card data
            const cardResponse = await fetch(`${BACKEND_URL}/api/cards`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...cardData,
                    ...fileData
                })
            });
            
            const result = await cardResponse.json();
            
            if (result.success) {
                showNotification(`Card ${cardData.card_id} saved!`, 'success');
                
                // Generate QR code
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(`${BACKEND_URL}/viewer.html?card=${cardData.card_id}`)}`;
                const viewerUrl = `${BACKEND_URL}/viewer.html?card=${cardData.card_id}`;
                
                document.getElementById('qrCodeContainer').innerHTML = `
                    <div class="qr-success">
                        <i class="fas fa-check-circle"></i>
                        <h3>Card Created!</h3>
                        <p>Card ID: <strong>${cardData.card_id}</strong></p>
                    </div>
                    <img src="${qrUrl}" alt="QR Code" class="qr-code-img">
                `;
                
                document.getElementById('shareableUrl').value = viewerUrl;
                document.getElementById('qrCodeSection').style.display = 'block';
                
                // Reload card list
                loadCards();
            } else {
                throw new Error(result.error);
            }
            
        } catch (error) {
            console.error('Save error:', error);
            showNotification('Save failed: ' + error.message, 'error');
        } finally {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }
    
    // Load cards from backend
    async function loadCards() {
        try {
            const response = await fetch(`${BACKEND_URL}/api/cards`);
            const result = await response.json();
            
            const tableBody = document.getElementById('cardsTableBody');
            
            if (result.success && result.cards && result.cards.length > 0) {
                let html = '';
                result.cards.forEach(card => {
                    const date = card.created_at ? new Date(card.created_at).toLocaleDateString() : 'Recent';
                    const preview = card.message_text ? 
                        (card.message_text.length > 30 ? card.message_text.substring(0, 30) + '...' : card.message_text) : 
                        '';
                    
                    html += `
                        <tr>
                            <td><strong>${card.card_id}</strong></td>
                            <td>${card.message_type}</td>
                            <td>${preview}</td>
                            <td>${date}</td>
                            <td>
                                <button class="action-btn view" onclick="loadCardToForm('${card.card_id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="action-btn delete" onclick="deleteCard('${card.card_id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            } else {
                tableBody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="5">No cards found. Create your first card!</td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Load cards error:', error);
        }
    }
    
    // Load card into form
    async function loadCardToForm(cardId) {
        try {
            const response = await fetch(`${BACKEND_URL}/api/cards/${cardId}`);
            const result = await response.json();
            
            if (result.success && result.card) {
                const card = result.card;
                const numericId = card.card_id.replace('CARD', '');
                
                document.getElementById('cardId').value = numericId;
                document.getElementById('contentType').value = card.message_type;
                document.getElementById('message').value = card.message_text || '';
                
                // Trigger change to update UI
                document.getElementById('contentType').dispatchEvent(new Event('change'));
                
                showNotification(`Loaded card: ${card.card_id}`, 'success');
            }
        } catch (error) {
            console.error('Load card error:', error);
        }
    }
    
    // Delete card
    async function deleteCard(cardId) {
        if (!confirm(`Delete card ${cardId}?`)) return;
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/cards/${cardId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(`Card ${cardId} deleted`, 'success');
                loadCards();
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            console.error('Delete error:', error);
            showNotification('Delete failed', 'error');
        }
    }
    
    // Helper functions
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        setTimeout(() => notification.classList.remove('show'), 3000);
    }
    
    // Global functions for buttons
    window.removeImage = function() {
        currentMedia.image = null;
        document.getElementById('imageInput').value = '';
        document.getElementById('imagePreview').classList.remove('active');
        updatePreview();
        showNotification('Image removed', 'info');
    };
    
    window.removeVideo = function() {
        if (currentMedia.video?.url) URL.revokeObjectURL(currentMedia.video.url);
        currentMedia.video = null;
        document.getElementById('videoInput').value = '';
        document.getElementById('videoPreview').classList.remove('active');
        updatePreview();
        showNotification('Video removed', 'info');
    };
    
    window.removeAudio = function() {
        if (currentMedia.audio?.url) URL.revokeObjectURL(currentMedia.audio.url);
        currentMedia.audio = null;
        document.getElementById('audioInput').value = '';
        document.getElementById('audioPreview').classList.remove('active');
        updatePreview();
        showNotification('Audio removed', 'info');
    };
    
    window.hideQRCode = function() {
        document.getElementById('qrCodeSection').style.display = 'none';
    };
    
    window.copyShareUrl = function() {
        const input = document.getElementById('shareableUrl');
        input.select();
        document.execCommand('copy');
        showNotification('URL copied!', 'success');
    };
    
    window.testOnPhone = function() {
        const url = document.getElementById('shareableUrl').value;
        alert(`Test on phone:\n\n1. Open this URL on your phone:\n${url}\n\n2. Or scan the QR code\n\n3. Card will display!`);
    };
    
    window.printQRCode = function() {
        const qrImg = document.querySelector('.qr-code-img');
        if (qrImg) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html><head><title>Print QR Code</title></head>
                <body style="text-align:center;padding:40px;">
                    <img src="${qrImg.src}" style="width:300px;height:300px;">
                    <p>Scan this QR code with any smartphone</p>
                    <button onclick="window.print()">Print</button>
                </body></html>
            `);
        }
    };
    
    // Make functions globally available
    window.loadCardToForm = loadCardToForm;
    window.deleteCard = deleteCard;
</script>
</body>
</html>
